name: ScanDog Security Scanner

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  
    scandog_trivy_scan:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
  
        # Container registry authentication (configured via ScanDog settings)
        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v2
          with:
            credentials_json: '${{ secrets.GCP_KEY }}'
  
        - name: Login to Google Artifact Registry
          run: |
            gcloud auth configure-docker europe-west4-docker.pkg.dev
  
        - name: Pull latest image
          run: |
            docker pull europe-west4-docker.pkg.dev/shared-services-20250105/dev-shared-backend/backend:latest
  
        - name: Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@0.28.0
          with:
            image-ref: europe-west4-docker.pkg.dev/shared-services-20250105/dev-shared-backend/backend:latest
            format: 'json'
            scanners: 'vuln'
            output: 'trivy-results.json'
  
        - name: Upload Trivy scan results
          uses: actions/upload-artifact@v4
          with:

            name: trivy-report
            path: trivy-results.json
  
        - name: Import results to ScanDog
          uses: scandogio/scandog-import@v1.1
          with:
            endpoint_type: "import"
            ci_run_id: ${{ github.run_id }}
            report_file: trivy-results.json
            workflow_id: 381355812d8c3eb4fc6e91aa0d2fddea
            scan_type: Container Scanner
            scanner: Trivy
            scandog_token: ${{ secrets.SCANDOG_TOKEN }}
            scandog_url: ${{ secrets.SCANDOG_URL }}
  