name: ScanDog Security Scanner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
      scandog_trivy_scan:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
    
          # Container registry authentication (configured via ScanDog settings)
    
    
          - name: Trivy vulnerability scanner
            uses: aquasecurity/trivy-action@0.28.0
            with:
              image-ref: mysql:9.3.0
              format: 'json'
              scanners: 'vuln'
              output: 'trivy-results.json'
    
          - name: Upload Trivy scan results
            uses: actions/upload-artifact@v4
            with:
  
              name: trivy-report
              path: trivy-results.json
    
          - name: Import results to ScanDog
            uses: scandogio/scandog-import@v1.1
            with:
              endpoint_type: "import"
              ci_run_id: ${{ github.run_id }}
              report_file: trivy-results.json
              workflow_id: 4cc8e5d8a07f6d0bc6b318fb9172be0b
              scan_type: Container Scanner
              scanner: Trivy
              scandog_token: ${{ secrets.SCANDOG_TOKEN }}
              scandog_url: ${{ secrets.SCANDOG_URL }}
  
      scandog_sonarcloud_scan:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
              fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
    
          - name: SonarQube Scan
            uses: SonarSource/sonarqube-scan-action@v6
            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              
          - name: ScanDog SonarQube Sync
            uses: scandogio/scandog-import@v1.1
            with:
              endpoint_type: 'sync'
              workflow_id: "4cc8e5d8a07f6d0bc6b318fb9172be0b"
              scanner: 'SonarQube'
              scan_type: 'SAST'
              ci_run_id: ${{ github.run_id }}
              project_key: DevSecOpsOrg_govwa
              scandog_token: ${{ secrets.SCANDOG_TOKEN }}
              scandog_url: ${{ secrets.SCANDOG_URL }}
  